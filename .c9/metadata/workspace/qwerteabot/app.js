{"changed":true,"filter":false,"title":"app.js","tooltip":"/qwerteabot/app.js","value":"function populate_users_table(mysql,bot) {\n\tbot.api.users.list({},function(err,response) {\n\t\tif (err) {throw(err);}\n\t\tresponse = response[\"members\"];\n\t\tfor(var i=0;i < response.length;i++) {\n\t\t\tif (response[i].deleted != true) {\n\t\t\t\tmysql.query(\n\n\t\t\t\t\t\"INSERT INTO `users` (`slackname`,`firstname`,`lastname`,`is_admin`,`is_owner`,`email`)\\\n\t\t\t\t\tVALUES(\\\n\t\t\t\t\t\" + mysql.escape(response[i].name) + \",\\\n\t\t\t\t\t\" + mysql.escape(response[i].profile.first_name || null) + \",\\\n\t\t\t\t\t\" + mysql.escape(response[i].profile.last_name || null) + \",\\\n\t\t\t\t\t\" + mysql.escape(response[i].is_admin || false) + \",\\\n\t\t\t\t\t\" + mysql.escape(response[i].is_owner || false) + \",\\\n\t\t\t\t\t\" + mysql.escape(response[i].profile.email) + \")\\\n\t\t\t\t\tON DUPLICATE KEY UPDATE\\\n\t\t\t\t\t`email`=\" + mysql.escape(response[i].profile.email) + \",\\\n\t\t\t\t\t`is_admin`=\" + mysql.escape(response[i].is_admin || false) + \",\\\n\t\t\t\t\t`is_owner`=\" + mysql.escape(response[i].is_owner || false) + \",\\\n\t\t\t\t\t`firstname`=\" + mysql.escape(response[i].profile.first_name || null) + \",\\\n\t\t\t\t\t`lastname`=\" + mysql.escape(response[i].profile.last_name || null)\n\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tmysql.query(\"DELETE FROM `users` WHERE `slackname`=\" + mysql.escape(response[i].name));\n\t\t\t}\n\t\t}\n\t});\n}\n\nfunction get_name_db(obj) {\n\tvar name = \"\";\n\tif (obj.firstname && obj.lastname) {\n\t\tname = obj.firstname + \" \" + obj.lastname + \" (@\" + obj.slackname + \")\";\n\t} else {\n\t\tname = \"@\" + obj.slackname;\n\t}\n\treturn name;\n}\n\nfunction time() {\n\treturn Math.round(+new Date() / 1000);\n}\n\ntry {\n\nvar Botkit = require(\"botkit\");\nvar request = require(\"request\");\nvar fs = require(\"fs\");\nvar MySQL = require(\"mysql\");\nvar md5 = require(\"md5\");\nvar controller = Botkit.slackbot();\n\nfs.readFile(\"config.json\",function(err,Config) {\n\tif (err) {\n\t\tthrow new Error(\"Error with opening the config file. Error:\\n\" + err);\n\t\treturn;\n\t}\n\n\ttry {\n\t\tConfig = JSON.parse(Config);\n\t} catch(err) {\n\t\tthrow new Error(\"Error with parsing JSON. Is your config file corrupted? Error: \" + err.toString());\n\t\treturn;\n\t}\n\n\tvar bot = controller.spawn(Config);\n\tbot.startRTM(function(err,bot,payload) {\n\t\tif (err) {\n\t\t\tthrow new Error(\"Could not connect to slack! \" + err);\n\t\t}\n\n\t\tvar channels;\n\t\tvar channels_ids;\n\n\t\tfunction updateChannelsArrays(cb) {\n\t\t\tchannels     = {};\n\t\t\tchannels_ids = {};\n\t\t\tbot.api.channels.list({},function(err,response) {\n\t\t\t\tif (err) {throw err;}\n\t\t\t\tfor (var i=0;i < response.channels.length;i++) {\n\n\t\t\t\t\tchannels[response.channels[i].name] = response.channels[i];\n\t\t\t\t\tchannels_ids[response.channels[i].id] = response.channels[i];\n\n\t\t\t\t}\n\t\t\t\tif (cb) {\n\t\t\t\t\tcb();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tupdateChannelsArrays(function() {\n\n\t\t\tvar users;\n\t\t\tvar users_ids;\n\n\t\t\tfunction updateUsersArrays(cb) {\n\t\t\t\tusers     = {};\n\t\t\t\tusers_ids = {};\n\t\t\t\tbot.api.users.list({},function(err,response) {\n\t\t\t\t\tif (err) {throw err;}\n\t\t\t\t\tfor (var i=0;i < response.members.length;i++) {\n\n\t\t\t\t\t\tusers[response.members[i].name] = response.members[i];\n\t\t\t\t\t\tusers_ids[response.members[i].id] = response.members[i];\n\n\t\t\t\t\t}\n\t\t\t\t\tif (cb) {\n\t\t\t\t\t\tcb();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tupdateUsersArrays(function() {\n\n\t\t\t\tvar MySQL_Connection = MySQL.createConnection({\n\t\t\t\t\thost     : Config.mysql.host,\n\t\t\t\t\tuser     : Config.mysql.username,\n\t\t\t\t\tpassword : Config.mysql.password,\n\t\t\t\t\tdatabase : Config.mysql.database,\n\t\t\t\t});\n\t\t\t\tMySQL_Connection.connect(function(err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tbot.say({\n\t\t\t\t\t\t\ttext: \"Error with connecting to the MySQL database!! Have you installed me correctly? Error:\\n\" + err,\n\t\t\t\t\t\t\tchannel: channels[\"qwertea\"].id,\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tMySQL_Connection.query(\"SHOW TABLES\",function(err,rows) {\n\t\t\t\t\t\tif (err) {throw(err);}\n\t\t\t\t\t\tvar found = false;\n\t\t\t\t\t\tfor(var i=0;i < rows.length;i++) {\n\t\t\t\t\t\t\tif (rows[i][\"Tables_in_\" + Config.mysql.database] == \"stringvars\") {\n\t\t\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!found) {\n\t\t\t\t\t\t\tbot.say({\n\t\t\t\t\t\t\t\ttext: \"Bot not installed correctly. Please use the online installer to set up the MySQL tables.\",\n\t\t\t\t\t\t\t\tchannel: channels[\"qwertea\"].id,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tMySQL_Connection.query(\"SELECT `value` FROM `stringvars` WHERE `key_`='installed' AND `value`='yes'\",function(err,rows) {\n\n\t\t\t\t\t\t\tif (err) {throw(err);}\n\t\t\t\t\t\t\tif (rows.length == 0) {\n\t\t\t\t\t\t\t\tbot.say({\n\t\t\t\t\t\t\t\t\ttext: \"Bot not installed correctly. Please use the online installer to set up the MySQL tables.\",\n\t\t\t\t\t\t\t\t\tchannel: channels[\"qwertea\"].id,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tpopulate_users_table(MySQL_Connection,bot);\n\n\t\t\t\t\t\t\tvar commands = {\n\n\t\t\t\t\t\t\t\t\"help\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Displays help for specific commands or all of them.\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\tif (args[0]) {\n\t\t\t\t\t\t\t\t\t\t\tif (commands[args[0]]) {\n\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"Sorry, but that command you need help with doesn't exist! (cAsE sEnSiTiVe) For a list of commands, type \\\"help\\\".\");\n\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\tif (commands[args[0]].help) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"Command:\\n\" + args[0] + \"\\n\\nExtra help:\\n\\n\" + commands[args[0]].help);\n\t\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"Command:\\n\" + args[0] + \"\\n\\nDescription:\\n\" + commands[args[0]].description);\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\tvar lengths = [];\n\t\t\t\t\t\t\t\t\t\t\tvar say = [];\n\t\t\t\t\t\t\t\t\t\t\tfor (var cmd in commands) {\n\t\t\t\t\t\t\t\t\t\t\t\tlengths.push([cmd,cmd.length]);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tlengths.sort(function(a,b) {\n\t\t\t\t\t\t\t\t\t\t\t\treturn a[1] - b[1];\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tlengths = lengths.reverse();\n\t\t\t\t\t\t\t\t\t\t\tfor(var i=0;i < lengths.length;i++) {\n\t\t\t\t\t\t\t\t\t\t\t\tsay.push(lengths[i][0] + (\" \").repeat(lengths[0][0].length - lengths[i][0].length) + \": \" + commands[lengths[i][0]].description);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"```\\n\" + say.join(\"\\n\") + \"\\n```\");\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"tea\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Start a tea round!.\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\tbot.reply(message, \"Starting a tea round!\")\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"logincode\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Used for logging into the site.\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\tupdateUsersArrays(function() {\n\t\t\t\t\t\t\t\t\t\t\tvar logincode = md5(users_ids[message.user].name + users_ids[message.user].profile.email + message.user + time());\n\t\t\t\t\t\t\t\t\t\t\tmysql.query(\"INSERT INTO `logincodes` (`logincode`,`expires`,`forwhom`) VALUES(\" + mysql.escape(logincode) + \",\" + mysql.escape(time() + 600) + \",\" + mysql.escape(users_ids[message.user].name) + \") ON DUPLICATE KEY UPDATE `logincode`=\" + mysql.escape(logincode) + \", `expires`=\" + mysql.escape(time() + 600),function(err,rows) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (err) {throw err;}\n\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"Your login code is: \" + logincode + \"\\nTo log in, go to \\n\" + Config.url + \" and paste your login code in the box. This code will expire after ten minutes.\");\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"mypoints\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Shows how many points you have in your balance\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\tbot.api.users.list({},function(err,response) {\n\t\t\t\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"Error with getting your details from the Slack API!\");\n\t\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tresponse = response[\"members\"];\n\t\t\t\t\t\t\t\t\t\t\tfor(var i=0;i < response.length;i++) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (response[i].id == message.user) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdateUsersArrays(function() {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tMySQL_Connection.query(\"SELECT `points` FROM `users` WHERE `slackname`=\" + MySQL_Connection.escape(users_ids[message.user].name),function(err,rows){\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (err) {throw(err);}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (rows[0].points == 1) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"You have: 1 point\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"You have: \" + rows[0].points + \" points\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"messageme\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Feeling lonely?\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\tbot.reply(message,(users_ids[message.user].profile.first_name || users_ids[message.user].name) + \", I've started a direct message conversation with you.\");\n\t\t\t\t\t\t\t\t\t\tbot.startPrivateConversation(message,function(err,dm) {\n\t\t\t\t\t\t\t\t\t\t\tif (err) {throw err;}\n\t\t\t\t\t\t\t\t\t\t\tdm.say(\"Hi, you asked for me?\");\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"leaderboard\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Displays a leaderboard so that you can name and shame your colleagues.\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\tbot.api.users.list({},function(err,response) {\n\t\t\t\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"Error with getting your details from the Slack API!\");\n\t\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tresponse = response[\"members\"];\n\t\t\t\t\t\t\t\t\t\t\tfor(var i=0;i < response.length;i++) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (response[i].id == message.user) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdateUsersArrays(function() {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tMySQL_Connection.query(\"SELECT * FROM `users` ORDER BY `points` DESC\",function(err,rows) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (err) {throw(err);}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar gen           = \"| Name\";\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar rowsn         = 10;\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar longestname   = 0;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar longestpoints = 0;\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfor(var i=0;i < rowsn;i++) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (get_name_db(rows[i]).length > longestname) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlongestname = get_name_db(rows[i]).length;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (rows[i].points.toString().length > longestpoints) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlongestpoints = rows[i].points.toString().length;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar n3 = longestname - 4;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (n3 < 0) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tn3 = 0;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar n4 = longestpoints - 6;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (n4 < 0) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tn4 = 0;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen = (\"=\").repeat(2 + 4 + n3 + 3 + 6 + n4 + 2) + \"\\n\" + gen;\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen += (\" \").repeat(longestname - 4) + \" |\";\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif ((longestpoints - 4) < 1) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen += \" Points |\";\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen += \" Points\" + (\" \").repeat(longestpoints - 6) + \" |\";\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen += \"\\n\" + (\"=\").repeat(2 + 4 + n3 + 3 + 6 + n4 + 2);\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen = \"```\\n\" + gen;\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfor(var i=0;i < rowsn;i++) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar m = get_name_db(rows[i]);\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar n1 = longestname - m.length;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (n1 < (4 - m.length)) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tn1 = 4 - m.length + 2;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar n2 = longestpoints - rows[i].points.toString().length;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (n2 < (6 - rows[i].points.toString().length)) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tn2 = 6 - longestpoints - rows[i].points.toString().length + 2;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen += \"\\n| \" + m + (\" \").repeat(n1) + \" | \" + rows[i].points + (\" \").repeat(n2) + \" |\";\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgen += \"\\n\" + (\"=\").repeat(2 + 4 + n3 + 3 + 6 + n4 + 2);\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,gen.replace(/\\n$/,\"\") + \"\\n```\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"avatar\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Displays your profile picture\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\tbot.api.users.list({},function(err,response) {\n\t\t\t\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"Error with getting your details from the Slack API!\");\n\t\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\tresponse = response[\"members\"];\n\t\t\t\t\t\t\t\t\t\t\tfor(var i=0;i < response.length;i++) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (response[i].id == message.user) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tbot.reply(message,\"http://gravatar.com/avatar/\" + md5(response[i].profile.email) + \"?s=500\");\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"cat\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Displays a random cat.\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\t  var reply_with_attachments = {\n\t\t\t\t\t\t\t\t\t\t    'text': request(\"http://random.cat/meow\", function(error, response, body) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t  if (!error && response.statusCode == 200) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar result = JSON.parse(body);\n\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t\t\t'icon_http://icons.iconarchive.com/icon\n\t\t\t\t\t\t\t\t\t\t    }\n\t\t\t\t\t\t\t\t\t\t\tbot.reply(message, reply_with_attachments);\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"insult\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Displays a random insult.\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\trequest(\"http://quandyfactory.com/insult/json\", function(error, response, body) {\n\t\t\t\t\t\t\t\t\t\t  if (!error && response.statusCode == 200) {\n\t\t\t\t\t\t\t\t\t\t\tvar result = JSON.parse(body);\n\t\t\t\t\t\t\t\t\t\t\tbot.reply(message, result.insult);\n\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"test\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Test\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\t  var reply_with_attachments = {\n\t\t\t\t\t\t\t\t\t\t    'username': 'Qwertea_Bot' ,\n\t\t\t\t\t\t\t\t\t\t    'text': 'This is a pre-text',\n\t\t\t\t\t\t\t\t\t\t    'attachments': [\n\t\t\t\t\t\t\t\t\t\t      {\n\t\t\t\t\t\t\t\t\t\t        'fallback': 'To be useful, I need your to invite me in a channel.',\n\t\t\t\t\t\t\t\t\t\t        'title': 'How can I help you?',\n\t\t\t\t\t\t\t\t\t\t        'text': 'To be useful, I need your to invite me in a channel ',\n\t\t\t\t\t\t\t\t\t\t        'color': '#7CD197'\n\t\t\t\t\t\t\t\t\t\t      }\n\t\t\t\t\t\t\t\t\t\t    ],\n\t\t\t\t\t\t\t\t\t\t    'icon_url': 'http://icons.iconarchive.com/icons/paomedia/small-n-flat/1024/sign-check-icon.png'\n\t\t\t\t\t\t\t\t\t\t    }\n\n\t\t\t\t\t\t\t\t\t\t  bot.reply(message, reply_with_attachments);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t\t\"joke\": {\n\t\t\t\t\t\t\t\t\t\"description\": \"Displays a random joke.\",\n\t\t\t\t\t\t\t\t\t\"function\"   : function(mysql,bot,message,args) {\n\t\t\t\t\t\t\t\t\t\trequest(\"http://tambal.azurewebsites.net/joke/random\", function(error, response, body) {\n\t\t\t\t\t\t\t\t\t\t  if (!error && response.statusCode == 200) {\n\t\t\t\t\t\t\t\t\t\t\tvar result = JSON.parse(body);\n\t\t\t\t\t\t\t\t\t\t\tbot.reply(message, result.joke);\n\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tvar events = {\n\n\t\t\t\t\t\t\t\t\"team_join\": {\n\t\t\t\t\t\t\t\t\t\"functions\": [\n\t\t\t\t\t\t\t\t\t\tfunction() {\n\t\t\t\t\t\t\t\t\t\t\tpopulate_users_table();\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tfor (event in events) {\n\t\t\t\t\t\t\t\tfor(var i=0;i < events[event].functions.length;i++) {\n\t\t\t\t\t\t\t\t\tcontroller.on(event,events[event].functions[i]);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tcontroller.hears(\".*\",[\"direct_message\"],function(bot,message) {\n\t\t\t\t\t\t\t\tvar args = message.text.split(\" \");\n\t\t\t\t\t\t\t\tif (commands[args[0]]) {\n\t\t\t\t\t\t\t\t\tcommands[args[0]].function(MySQL_Connection,bot,message,args.splice(1));\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tbot.reply(message,\"Sorry, but that command doesn't exist! (cAsE sEnSiTiVe) For a list of commands, type \\\"help\\\".\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tcontroller.hears(\".*\",[\"ambient\"],function(bot,message) {\n\t\t\t\t\t\t\t\tif (channels_ids[message.channel].name != \"qwertea\") {return;}\n\t\t\t\t\t\t\t\tvar args = message.text.split(\" \");\n\t\t\t\t\t\t\t\tif (args[0] == \"messageme\") {\n\t\t\t\t\t\t\t\t\tcommands[args[0]].function(MySQL_Connection,bot,message,args.splice(1));\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tbot.reply(message,\"Please *don't* use this channel to message the bot. This channel is for announcements, notifications and the `messageme` command.\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tbot.say({\n\t\t\t\t\t\t\t\tchannel: channels[\"qwertea\"].id,\n\t\t\t\t\t\t\t\ttext   : \"Hello world! I'm alive!\",\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t});\n\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t});\n\n\t\t});\n\n\t});\n\n});\n\n} catch(err) {\n\n\tprocess.kill(process.pid,\"SIGTERM\");\n\n}","undoManager":{"mark":-2,"position":57,"stack":[[{"start":{"row":361,"column":11},"end":{"row":361,"column":15},"action":"remove","lines":["    "],"id":846,"ignore":true},{"start":{"row":361,"column":17},"end":{"row":361,"column":24},"action":"remove","lines":["url': '"]},{"start":{"row":361,"column":98},"end":{"row":361,"column":107},"action":"insert","lines":["emoji': '"]}],[{"start":{"row":361,"column":106},"end":{"row":361,"column":108},"action":"remove","lines":["''"],"id":847}],[{"start":{"row":361,"column":105},"end":{"row":361,"column":106},"action":"remove","lines":[" "],"id":848}],[{"start":{"row":361,"column":104},"end":{"row":361,"column":105},"action":"remove","lines":[":"],"id":849}],[{"start":{"row":361,"column":103},"end":{"row":361,"column":104},"action":"remove","lines":["'"],"id":850}],[{"start":{"row":361,"column":102},"end":{"row":361,"column":103},"action":"remove","lines":["i"],"id":851}],[{"start":{"row":361,"column":101},"end":{"row":361,"column":102},"action":"remove","lines":["j"],"id":852}],[{"start":{"row":361,"column":100},"end":{"row":361,"column":101},"action":"remove","lines":["o"],"id":853}],[{"start":{"row":361,"column":99},"end":{"row":361,"column":100},"action":"remove","lines":["m"],"id":854}],[{"start":{"row":361,"column":98},"end":{"row":361,"column":99},"action":"remove","lines":["e"],"id":855}],[{"start":{"row":361,"column":97},"end":{"row":361,"column":98},"action":"remove","lines":["g"],"id":856}],[{"start":{"row":361,"column":96},"end":{"row":361,"column":97},"action":"remove","lines":["n"],"id":857}],[{"start":{"row":361,"column":95},"end":{"row":361,"column":96},"action":"remove","lines":["p"],"id":858}],[{"start":{"row":361,"column":94},"end":{"row":361,"column":95},"action":"remove","lines":["."],"id":859}],[{"start":{"row":361,"column":93},"end":{"row":361,"column":94},"action":"remove","lines":["n"],"id":860}],[{"start":{"row":361,"column":92},"end":{"row":361,"column":93},"action":"remove","lines":["o"],"id":861}],[{"start":{"row":361,"column":91},"end":{"row":361,"column":92},"action":"remove","lines":["c"],"id":862}],[{"start":{"row":361,"column":90},"end":{"row":361,"column":91},"action":"remove","lines":["i"],"id":863}],[{"start":{"row":361,"column":89},"end":{"row":361,"column":90},"action":"remove","lines":["-"],"id":864}],[{"start":{"row":361,"column":88},"end":{"row":361,"column":89},"action":"remove","lines":["k"],"id":865}],[{"start":{"row":361,"column":87},"end":{"row":361,"column":88},"action":"remove","lines":["c"],"id":866}],[{"start":{"row":361,"column":86},"end":{"row":361,"column":87},"action":"remove","lines":["e"],"id":867}],[{"start":{"row":361,"column":85},"end":{"row":361,"column":86},"action":"remove","lines":["h"],"id":868}],[{"start":{"row":361,"column":84},"end":{"row":361,"column":85},"action":"remove","lines":["c"],"id":869}],[{"start":{"row":361,"column":83},"end":{"row":361,"column":84},"action":"remove","lines":["-"],"id":870}],[{"start":{"row":361,"column":82},"end":{"row":361,"column":83},"action":"remove","lines":["n"],"id":871}],[{"start":{"row":361,"column":81},"end":{"row":361,"column":82},"action":"remove","lines":["g"],"id":872}],[{"start":{"row":361,"column":80},"end":{"row":361,"column":81},"action":"remove","lines":["i"],"id":873}],[{"start":{"row":361,"column":79},"end":{"row":361,"column":80},"action":"remove","lines":["s"],"id":874}],[{"start":{"row":361,"column":78},"end":{"row":361,"column":79},"action":"remove","lines":["/"],"id":875}],[{"start":{"row":361,"column":77},"end":{"row":361,"column":78},"action":"remove","lines":["4"],"id":876}],[{"start":{"row":361,"column":76},"end":{"row":361,"column":77},"action":"remove","lines":["2"],"id":877}],[{"start":{"row":361,"column":75},"end":{"row":361,"column":76},"action":"remove","lines":["0"],"id":878}],[{"start":{"row":361,"column":74},"end":{"row":361,"column":75},"action":"remove","lines":["1"],"id":879}],[{"start":{"row":361,"column":73},"end":{"row":361,"column":74},"action":"remove","lines":["/"],"id":880}],[{"start":{"row":361,"column":72},"end":{"row":361,"column":73},"action":"remove","lines":["t"],"id":881}],[{"start":{"row":361,"column":71},"end":{"row":361,"column":72},"action":"remove","lines":["a"],"id":882}],[{"start":{"row":361,"column":70},"end":{"row":361,"column":71},"action":"remove","lines":["l"],"id":883}],[{"start":{"row":361,"column":69},"end":{"row":361,"column":70},"action":"remove","lines":["f"],"id":884}],[{"start":{"row":361,"column":68},"end":{"row":361,"column":69},"action":"remove","lines":["-"],"id":885}],[{"start":{"row":361,"column":67},"end":{"row":361,"column":68},"action":"remove","lines":["n"],"id":886}],[{"start":{"row":361,"column":66},"end":{"row":361,"column":67},"action":"remove","lines":["-"],"id":887}],[{"start":{"row":361,"column":65},"end":{"row":361,"column":66},"action":"remove","lines":["l"],"id":888}],[{"start":{"row":361,"column":64},"end":{"row":361,"column":65},"action":"remove","lines":["l"],"id":889}],[{"start":{"row":361,"column":63},"end":{"row":361,"column":64},"action":"remove","lines":["a"],"id":890}],[{"start":{"row":361,"column":62},"end":{"row":361,"column":63},"action":"remove","lines":["m"],"id":891}],[{"start":{"row":361,"column":61},"end":{"row":361,"column":62},"action":"remove","lines":["s"],"id":892}],[{"start":{"row":361,"column":60},"end":{"row":361,"column":61},"action":"remove","lines":["/"],"id":893}],[{"start":{"row":361,"column":59},"end":{"row":361,"column":60},"action":"remove","lines":["a"],"id":894}],[{"start":{"row":361,"column":58},"end":{"row":361,"column":59},"action":"remove","lines":["i"],"id":895}],[{"start":{"row":361,"column":57},"end":{"row":361,"column":58},"action":"remove","lines":["d"],"id":896}],[{"start":{"row":361,"column":56},"end":{"row":361,"column":57},"action":"remove","lines":["e"],"id":897}],[{"start":{"row":361,"column":55},"end":{"row":361,"column":56},"action":"remove","lines":["m"],"id":898}],[{"start":{"row":361,"column":54},"end":{"row":361,"column":55},"action":"remove","lines":["o"],"id":899}],[{"start":{"row":361,"column":53},"end":{"row":361,"column":54},"action":"remove","lines":["a"],"id":900}],[{"start":{"row":361,"column":52},"end":{"row":361,"column":53},"action":"remove","lines":["p"],"id":901}],[{"start":{"row":361,"column":51},"end":{"row":361,"column":52},"action":"remove","lines":["/"],"id":902}],[{"start":{"row":361,"column":50},"end":{"row":361,"column":51},"action":"remove","lines":["s"],"id":903}]]},"ace":{"folds":[],"scrolltop":4761,"scrollleft":0,"selection":{"start":{"row":361,"column":50},"end":{"row":361,"column":50},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":339,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1466671618915}